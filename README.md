# G.B.S – Gundam Battle System (Discord Bot)

ガンダムTRPGの戦闘と管理を自動化する Discord Bot。  
技能判定/機体シート/同調率/部位破壊/行動盤面の入力共有など、卓運用を省力化します。

## ✨ Features
- **行動盤面**: `/board create|add|mode|sheet` + セレクトUIで座標/ARTS/対象を予約、公開、確定
- **精度計算**: `/acc`（RANGE補正 & 同調率 × 乗算）
- **速度計算**: `/speed`（表記はコード参照）
- **回避計算**: `/avoid`
- **機体管理**: `/ms import|list|select|sheet|armor ...` + 自然文「機動」「装甲」返信
- **部位破壊**: `/parts show|break|random|reset`（※機体ごとに記録）
- **ULT**: `/ult on|off|toggle|status`（キャラ毎の入力予約と同列で扱える設計）

## 🧱 Tech
- Node.js + TypeScript / discord.js v14
- データ永続: JSON/SQLite（モジュール構成に依存）
- ツール: pnpm or npm / tsx / dotenv

## 🚀 Quick Start

1. **Discord Developer Portal** で Bot 作成、Privileged Intents を必要に応じてON  
   （Presence/Members/Message Content 等）
2. `.env` を作成（`.env.example` をコピー）
3. 依存インストール & ビルド
   ```
   npm i
   npm run build
   ```
4. 起動
   ```
   npm run start
   ```
5. スラッシュコマンド登録/削除
   ```
   npm run register:guild（高速反映/テスト向け）
   npm run register:global（グローバル登録/数分～最長1時間の伝播遅延あり）
   npm run unregister:guild（ギルドコマンド削除）
   ```
   

# 💻G.B.S - GundamBattleSystem Bot 取扱説明（ユーザー用）

## 0) 事前準備（共通）

- キャラ・機体は**JSON貼り付け**で登録 → **チャンネルごとに選択**して使います。
    
- データは `data/*.json` に**自動保存**。Botを落としても残ります。
    

## 1) 機体＆キャラの登録・選択（PL）

### 機体

- 登録：  
    `/ms import json:<機体シートJSON>`  
    例：
    
    ```json
    {
      "機体": {"名前":"プロト","Type":"F","TLv":10,"機動":5,"装甲":3,"積載":5}
    }
    ```
    
- 一覧：`/ms list` （ボタンで選択/削除）
    
- 選択：`/ms select id_or_name:<ID|名前>`
    
- シート表示：`/ms sheet`（以後、装甲変更時に自動更新）
    
- 装甲操作：`/ms armor add|sub|set value:<N>`
    
- 今の選択：`/ms whoami`
    

### キャラ

- 登録：`/pc import json:<キャラJSON>`
    
- 一覧：`/pc list`
    
- 選択：`/pc select id_or_name:<ID|名前>`
    
- シート表示：`/pc sheet`
    
- 今の選択：`/pc whoami`
    

## 2) 戦闘前（GM）

### 座標盤面を用意

- 盤面作成：`/board create size:<1..25> [mode:free|battle]`  
    ※通常は **battle** 推奨（同時入力→一斉公開）
    
- 参加者登録：`/board add name:<表示名>` を人数分  
    NPCも自由に追加できます（他データとの連携不要）。
    

> 表示/更新は `表示/更新` ボタン。盤面は同じメッセージを**編集更新**します。

## 3) SELECT PHASE（各PL）

1. 盤面UIで
    
    - 「キャラを選択」
        
    - 「座標を選択」
        
    - 「ARTS.No を選択（0=行動なし）」
        
    - 「対象を選択（任意／なし可）」
        
2. **確定**を押す → 「座標 / ARTS.No / 対象」を**本人あてに通知**（ephemeral）
    
3. 全員確定すると、**同じチャンネル**に「行動公開」メッセージが自動投稿  
    形式：`名前：移動前 → 移動先 ／ ARTS.No.X ／ 対象 Y`
    
4. その後、盤面に**一斉反映**されます
    

> 途中で様子を見たい時は「表示/更新」。  
> 参加者削除は「削除」＋対象選択。

## 4) ACTION PHASE（計算支援）

### 4-1. 速度指数

- 自機の**機動**（選択した機体の値）と技能行使Lvから計算：  
    `/speed level:<技能行使Lv>`  
    出力：
    
    ```
    【速度指数の計算】
    機体名：◯◯
    機動：5
    技能行使（機動制御）：7
    
    速度指数＝7×5＝35
    ```
    

### 4-2. 精度指数

- 入力は**自由入力**（登録値は参照しない＝自由度確保）
    
- 同調率は機体保持値（-6..+6）が自動乗算されます  
    `/acc level:<技能行使Lv> base_rate:<基礎精度率%> range:<有効射程> dist:<座標差量>`  
    出力：
    
    ```
    【精度指数の計算】
    技能行使Lv：5
    基礎精度率：120.0%
    有効射程　：3
    座標差量　：1
    同調率　　：+2（200%）（200%）
    
    式の分解
    (精度率) ＝ 120.0% − (2×10%) ＋ 0.0%
    　　　 　＝ 100.0%
     5 × 1.00 ＝ 5.00
    (精度指数) ＝ 5.00 × 2.00 ＝ 10.00
    ```
    

### 4-3. 回避／命中指数

- `/avoid mobility:<機動> accuracy:<精度指数> [level:<機動制御Lv=10既定>]`  
    出力：
    
    ```
    【回避指数/命中指数の計算】
    【機動制御】Lv：5
    機動： 8
    精度指数： 7.7
    (回避率) ＝ 100％ + (10％×0.3) ＝ 103.0％
    (回避指数) ＝ 5 (103.0％) ＝ 5.2
    (命中指数) ＝ 7.7 − 5.2 ＝ 2.5
    ```
    

## 5) 部位破壊（PL/GM）

- 現在の状態表示：`/parts show`
    
- 指定破壊：`/parts break number:<1..8>`
    
- ランダム破壊：`/parts random count:<1..8>`
    
- リセット：`/parts reset`
    

> 部位は**選択中キャラ単位**で記録（1..8：頭部/左腕/右腕/左脚/右脚/左翼/右翼/コックピット）。  
> 「部位」という単語投稿で一覧を出すメッセージトリガあり。

## 6) メッセージトリガ（自然文反応）

- 機体プロパティ：**「Type / TLv / 機動 / 装甲 / 積載」** を単語で投稿 → 選択中機体の値を返信
    
- 技能ロール：キャラ機能の**技能名（＋補正）**を投稿 → ロール表示（例：「機動制御 +2」）
    

## 7) 同調率

- 機体ごとに **-6 〜 +6** のランクを保持（初期 0）
    
- 倍率はポケモンにおける能力ランクのものと同一。
    
    - +6: 400%(8/2), +5: 350%, +4: 300%, …, 0: 100%(2/2), -1: ~66%(2/3), …, -6: 25%(2/8)
        
- 変更（GM裁量・手動管理想定）：
    
    - **コマンドは不要**（現仕様では変更APIは作っていません。必要なら `/ms sync set` を後日実装可）
        
- 現在値の確認：**「同調率」** と単語投稿で返信
    

## 9) 役割別クイックリファレンス

### GM

- 盤面作成 `/board create size:10 mode:battle`
    
- 参加者追加 `/board add name:アムロ` …
    
- ラウンド進行：各人の**確定**を待つ → 自動で「行動公開」→ 反映
    

### PL

- 初回：`/ms(pc) import` → `/ms(pc) select`
    
- SELECT：盤面UIで選択 → **確定**
    
- ACTION：`/speed` → `/acc` → `/avoid`
    
- 被弾管理：`/parts …`
